name: "ğŸ” ECWoC'26 Duplicate Issue Detector"

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  detect-duplicate:
    runs-on: ubuntu-latest

    steps:
      - name: "Check for Duplicate Issues (ECWoC'26)"
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            async function run() {
              const newIssue = context.payload.issue;
              const newTitle = (newIssue.title || '').toLowerCase();
              const newBody = (newIssue.body || '').toLowerCase();

              const { owner, repo } = context.repo;

              const issues = await github.rest.issues.listForRepo({
                owner,
                repo,
                state: 'open',
                per_page: 100
              });

              for (const issue of issues.data) {
                if (issue.number === newIssue.number) continue;

                const oldTitle = (issue.title || '').toLowerCase();
                const oldBody = (issue.body || '').toLowerCase();

                if (
                  oldTitle.includes(newTitle) ||
                  newTitle.includes(oldTitle) ||
                  (newBody && oldBody && oldBody.includes(newBody))
                ) {

                  const comment = `
## ğŸ” Possible Duplicate Issue (ECWoC'26)

Hi @${newIssue.user.login} ğŸ‘‹

This issue looks similar to an existing one:

ğŸ‘‰ **#${issue.number} â€“ ${issue.title}**

### What should you do?
- If this is the same issue, please continue the discussion there.
- If itâ€™s different, explain how this issue is unique.

Thank you for helping keep the repository organized during **ECWoC'26** ğŸš€

---
ğŸ¤– Automated duplicate detection
`;

                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: newIssue.number,
                    body: comment
                  });

                  await github.rest.issues.addLabels({
                    owner,
                    repo,
                    issue_number: newIssue.number,
                    labels: ["ECWoC26", "possible-duplicate", "automated"]
                  });

                  break;
                }
              }
            }

            run();
