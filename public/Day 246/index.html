<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnapEditor Pro - Advanced Screen Capture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .canvas-container {
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .tool-btn {
            @apply p-2.5 rounded-xl transition-all duration-200 flex items-center justify-center text-slate-400 hover:bg-slate-800 hover:text-white;
        }

        .tool-btn.active {
            @apply bg-indigo-600 text-white shadow-lg shadow-indigo-500/30 ring-2 ring-indigo-400 ring-offset-2 ring-offset-slate-900;
        }

        #mainCanvas {
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            transition: filter 0.2s ease;
            cursor: crosshair;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #6366f1;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Filter Preview Cards */
        .filter-card {
            @apply flex flex-col items-center gap-1 p-2 rounded-lg border border-slate-800 hover:bg-slate-800 cursor-pointer transition-all;
        }
        .filter-card.active { @apply border-indigo-500 bg-indigo-500/10; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Top Navigation -->
    <header class="h-14 border-b border-slate-800 bg-slate-900/80 backdrop-blur-xl flex items-center justify-between px-6 z-30 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </div>
            <span class="font-bold text-lg tracking-tight">SnapEditor <span class="text-indigo-400">Pro</span></span>
        </div>

        <div class="flex items-center gap-2">
            <div id="editingControls" class="hidden flex items-center gap-2 mr-4">
                <button onclick="undo()" class="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition-all" title="Undo (Ctrl+Z)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/></svg>
                </button>
                <div class="h-6 w-px bg-slate-800 mx-2"></div>
                <button onclick="downloadImage()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded-lg text-sm font-semibold transition-all">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
                    Export PNG
                </button>
                <button onclick="resetApp()" class="p-2 hover:bg-red-500/10 text-red-400 rounded-lg transition-all">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                </button>
            </div>
            
            <button id="captureBtn" onclick="captureScreen()" class="flex items-center gap-2 bg-slate-100 hover:bg-white text-slate-900 px-4 py-1.5 rounded-lg text-sm font-bold transition-all active:scale-95">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/></svg>
                Capture Screen
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        <!-- Welcome View -->
        <div id="welcomeScreen" class="absolute inset-0 flex flex-col items-center justify-center bg-[#020617] z-20">
            <div class="max-w-md w-full px-6 text-center">
                <h2 class="text-5xl font-black mb-6 bg-gradient-to-b from-white to-slate-500 bg-clip-text text-transparent">Design in a snap.</h2>
                <p class="text-slate-400 text-lg mb-8">Professional screenshot editing suite. Freehand, shapes, filters, and smart cropping.</p>
                <div class="grid grid-cols-2 gap-4 mb-8 text-left">
                    <div class="p-4 bg-slate-900/50 border border-slate-800 rounded-2xl">
                        <div class="text-indigo-400 mb-2 font-bold text-sm">CAPTURE</div>
                        <div class="text-xs text-slate-500">Full screen, windows, or specific tabs.</div>
                    </div>
                    <div class="p-4 bg-slate-900/50 border border-slate-800 rounded-2xl">
                        <div class="text-purple-400 mb-2 font-bold text-sm">PASTE</div>
                        <div class="text-xs text-slate-500">Ctrl+V to edit images from clipboard.</div>
                    </div>
                </div>
                <button onclick="captureScreen()" class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 rounded-2xl font-bold text-lg shadow-2xl shadow-indigo-500/20 transition-all flex items-center justify-center gap-3">
                    Start New Project
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14m-7-7l7 7-7 7"/></svg>
                </button>
            </div>
        </div>

        <!-- Professional Editor Interface -->
        <div id="editorLayout" class="hidden flex-1 flex h-full overflow-hidden">
            
            <!-- Left Sidebar: Tools -->
            <aside class="w-16 md:w-20 bg-slate-900 border-r border-slate-800 flex flex-col items-center py-6 gap-4 shrink-0">
                <button onclick="setTool('pencil', this)" class="tool-btn active" title="Pencil (P)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                </button>
                <button onclick="setTool('rect', this)" class="tool-btn" title="Rectangle (R)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                </button>
                <button onclick="setTool('circle', this)" class="tool-btn" title="Circle (C)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"/></svg>
                </button>
                <button onclick="setTool('arrow', this)" class="tool-btn" title="Arrow (A)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
                <button onclick="setTool('text', this)" class="tool-btn" title="Text (T)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>
                </button>
                <button onclick="setTool('eraser', this)" class="tool-btn" title="Eraser (E)">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 20H7L3 16C2 15 2 13 3 12L13 2L22 11L20 20Z"/></svg>
                </button>
                <div class="h-px w-8 bg-slate-800 my-2"></div>
                <button onclick="setTool('crop', this)" class="tool-btn" title="Crop Selection">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M6.13 1L6 16a2 2 0 002 2h15"/><path d="M1 6.13L16 6a2 2 0 012 2v15"/></svg>
                </button>
            </aside>

            <!-- Canvas Area -->
            <section class="flex-1 bg-slate-950 overflow-auto flex items-center justify-center p-12 canvas-container custom-scrollbar" id="viewport">
                <div class="relative">
                    <canvas id="mainCanvas"></canvas>
                    <!-- Crop Overlay UI -->
                    <div id="cropOverlay" class="hidden absolute border-2 border-dashed border-white ring-[9999px] ring-black/60 pointer-events-none"></div>
                </div>
            </section>

            <!-- Right Sidebar: Properties -->
            <aside class="hidden lg:flex w-64 bg-slate-900 border-l border-slate-800 flex-col p-5 shrink-0 overflow-y-auto custom-scrollbar">
                <div class="mb-8">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Stroke & Color</h3>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="setColor('#ef4444')" class="w-8 h-8 rounded-lg bg-red-500 transition-transform hover:scale-110" title="Red"></button>
                        <button onclick="setColor('#3b82f6')" class="w-8 h-8 rounded-lg bg-blue-500 transition-transform hover:scale-110" title="Blue"></button>
                        <button onclick="setColor('#22c55e')" class="w-8 h-8 rounded-lg bg-green-500 transition-transform hover:scale-110" title="Green"></button>
                        <button onclick="setColor('#eab308')" class="w-8 h-8 rounded-lg bg-yellow-500 transition-transform hover:scale-110" title="Yellow"></button>
                        <button onclick="setColor('#ffffff')" class="w-8 h-8 rounded-lg bg-white border border-slate-200 transition-transform hover:scale-110" title="White"></button>
                        <button onclick="setColor('#000000')" class="w-8 h-8 rounded-lg bg-black border border-slate-700 transition-transform hover:scale-110" title="Black"></button>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-xs text-slate-400">
                            <span>Size</span>
                            <span id="brushSizeVal">5px</span>
                        </div>
                        <input type="range" id="brushSize" min="1" max="50" value="5" class="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-indigo-500" oninput="updateBrushVal(this.value)">
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4">Filters</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="filter-card active" onclick="applyFilter('none', this)">
                            <div class="w-full h-10 bg-slate-800 rounded border border-slate-700 mb-1 overflow-hidden">
                                <div class="w-full h-full bg-gradient-to-tr from-indigo-500 to-purple-500"></div>
                            </div>
                            <span class="text-[10px] font-medium">None</span>
                        </div>
                        <div class="filter-card" onclick="applyFilter('grayscale(100%)', this)">
                            <div class="w-full h-10 bg-slate-800 rounded border border-slate-700 mb-1 overflow-hidden grayscale">
                                <div class="w-full h-full bg-gradient-to-tr from-indigo-500 to-purple-500"></div>
                            </div>
                            <span class="text-[10px] font-medium">Mono</span>
                        </div>
                        <div class="filter-card" onclick="applyFilter('sepia(80%)', this)">
                            <div class="w-full h-10 bg-slate-800 rounded border border-slate-700 mb-1 overflow-hidden sepia">
                                <div class="w-full h-full bg-gradient-to-tr from-indigo-500 to-purple-500"></div>
                            </div>
                            <span class="text-[10px] font-medium">Sepia</span>
                        </div>
                        <div class="filter-card" onclick="applyFilter('invert(100%)', this)">
                            <div class="w-full h-10 bg-slate-800 rounded border border-slate-700 mb-1 overflow-hidden invert">
                                <div class="w-full h-full bg-gradient-to-tr from-indigo-500 to-purple-500"></div>
                            </div>
                            <span class="text-[10px] font-medium">Negative</span>
                        </div>
                    </div>
                </div>

                <div class="mt-auto pt-4 border-t border-slate-800">
                    <p class="text-[10px] text-slate-500 leading-tight">
                        Shortcuts:<br>
                        P: Pencil | R: Rect | C: Circle<br>
                        T: Text | E: Eraser | Shift: Straight<br>
                        Ctrl+Z: Undo | Ctrl+V: Paste
                    </p>
                </div>
            </aside>
        </div>
    </main>

    <div id="toastContainer" class="fixed bottom-6 right-6 z-50 pointer-events-none"></div>

    <script>
        let currentScreenshot = null;
        let canvas, ctx;
        let isDrawing = false;
        let currentTool = 'pencil';
        let currentColor = '#ffffff';
        let history = [];
        let undoPointer = -1;
        
        let startX, startY;
        let tempCanvasData; // For previewing shapes while dragging
        let currentFilter = 'none';

        function initCanvas() {
            canvas = document.getElementById('mainCanvas');
            ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            canvas.addEventListener('mousedown', startAction);
            canvas.addEventListener('mousemove', handleMove);
            window.addEventListener('mouseup', endAction);
            
            // Clipboard support
            window.addEventListener('paste', handlePaste);
            
            // Keyboard Shortcuts
            window.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
                const toolKeys = { 'p': 'pencil', 'r': 'rect', 'c': 'circle', 't': 'text', 'e': 'eraser', 'a': 'arrow' };
                if (toolKeys[e.key.toLowerCase()]) {
                    const btn = document.querySelector(`[title*="${e.key.toUpperCase()}"]`);
                    if (btn) btn.click();
                }
            });
        }

        async function captureScreen() {
            const btn = document.getElementById('captureBtn');
            const originalContent = btn.innerHTML;
            try {
                btn.disabled = true;
                btn.innerHTML = `<div class="spinner"></div>`;
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    setTimeout(() => {
                        const off = document.createElement('canvas');
                        off.width = video.videoWidth;
                        off.height = video.videoHeight;
                        off.getContext('2d').drawImage(video, 0, 0);
                        currentScreenshot = off.toDataURL('image/png');
                        stream.getTracks().forEach(t => t.stop());
                        setupEditor();
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }, 500);
                };
            } catch (err) {
                btn.disabled = false;
                btn.innerHTML = originalContent;
                showToast("Capture failed", "error");
            }
        }

        function handlePaste(e) {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let item of items) {
                if (item.type.indexOf("image") !== -1) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        currentScreenshot = event.target.result;
                        setupEditor();
                    };
                    reader.readAsDataURL(blob);
                }
            }
        }

        function setupEditor() {
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('editorLayout').classList.remove('hidden');
            document.getElementById('editingControls').classList.remove('hidden');
            if (!canvas) initCanvas();
            const img = new Image();
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.filter = currentFilter;
                ctx.drawImage(img, 0, 0);
                saveState();
            };
            img.src = currentScreenshot;
        }

        function updateBrushVal(v) { document.getElementById('brushSizeVal').textContent = v + 'px'; }

        function setTool(tool, el) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('cropOverlay').classList.add('hidden');
        }

        function setColor(c) { currentColor = c; showToast("Color updated"); }

        function applyFilter(f, el) {
            currentFilter = f;
            document.querySelectorAll('.filter-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            canvas.style.filter = f;
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
        }

        function startAction(e) {
            isDrawing = true;
            const pos = getPos(e);
            startX = pos.x;
            startY = pos.y;
            tempCanvasData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            if (currentTool === 'pencil') {
                ctx.beginPath();
                ctx.moveTo(startX, startY);
            } else if (currentTool === 'text') {
                addText(pos.x, pos.y);
                isDrawing = false;
            } else if (currentTool === 'crop') {
                document.getElementById('cropOverlay').classList.remove('hidden');
            }
        }

        function handleMove(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            const size = document.getElementById('brushSize').value;
            
            ctx.lineWidth = size;
            ctx.strokeStyle = currentColor;
            ctx.fillStyle = currentColor;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (currentTool === 'pencil' || currentTool === 'eraser') {
                ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            } else if (['rect', 'circle', 'arrow', 'crop'].includes(currentTool)) {
                // Restore previous state to preview shape
                ctx.putImageData(tempCanvasData, 0, 0);
                ctx.globalCompositeOperation = 'source-over';
                
                if (currentTool === 'rect') {
                    ctx.strokeRect(startX, startY, pos.x - startX, pos.y - startY);
                } else if (currentTool === 'circle') {
                    ctx.beginPath();
                    const radius = Math.sqrt(Math.pow(pos.x - startX, 2) + Math.pow(pos.y - startY, 2));
                    ctx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    ctx.stroke();
                } else if (currentTool === 'arrow') {
                    drawArrow(startX, startY, pos.x, pos.y);
                } else if (currentTool === 'crop') {
                    updateCropUI(e);
                }
            }
        }

        function endAction(e) {
            if (!isDrawing) return;
            isDrawing = false;
            
            if (currentTool === 'crop') {
                finalizeCrop(e);
            } else {
                saveState();
            }
        }

        function drawArrow(x1, y1, x2, y2) {
            const headlen = 15;
            const angle = Math.atan2(y2 - y1, x2 - x1);
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle - Math.PI / 6), y2 - headlen * Math.sin(angle - Math.PI / 6));
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headlen * Math.cos(angle + Math.PI / 6), y2 - headlen * Math.sin(angle + Math.PI / 6));
            ctx.stroke();
        }

        function updateCropUI(e) {
            const rect = canvas.getBoundingClientRect();
            const overlay = document.getElementById('cropOverlay');
            const x = Math.min(e.clientX, startX / (canvas.width / rect.width) + rect.left);
            const y = Math.min(e.clientY, startY / (canvas.height / rect.height) + rect.top);
            const w = Math.abs(e.clientX - (startX / (canvas.width / rect.width) + rect.left));
            const h = Math.abs(e.clientY - (startY / (canvas.height / rect.height) + rect.top));
            
            overlay.style.left = (x - rect.left) + 'px';
            overlay.style.top = (y - rect.top) + 'px';
            overlay.style.width = w + 'px';
            overlay.style.height = h + 'px';
        }

        function finalizeCrop(e) {
            const pos = getPos(e);
            const left = Math.min(startX, pos.x);
            const top = Math.min(startY, pos.y);
            const width = Math.abs(pos.x - startX);
            const height = Math.abs(pos.y - startY);
            
            if (width < 10 || height < 10) {
                document.getElementById('cropOverlay').classList.add('hidden');
                return;
            }

            const cropData = ctx.getImageData(left, top, width, height);
            canvas.width = width;
            canvas.height = height;
            ctx.putImageData(cropData, 0, 0);
            
            document.getElementById('cropOverlay').classList.add('hidden');
            setTool('pencil', document.querySelector('[title*="Pencil"]'));
            saveState();
            showToast("Image cropped");
        }

        function addText(x, y) {
            const t = prompt("Enter text overlay:");
            if (t) {
                const size = document.getElementById('brushSize').value * 4;
                ctx.font = `bold ${size}px 'Plus Jakarta Sans'`;
                ctx.fillStyle = currentColor;
                ctx.fillText(t, x, y);
                saveState();
            }
        }

        function saveState() {
            if (undoPointer < history.length - 1) history = history.slice(0, undoPointer + 1);
            history.push(canvas.toDataURL());
            if (history.length > 30) history.shift();
            undoPointer = history.length - 1;
        }

        function undo() {
            if (undoPointer > 0) {
                undoPointer--;
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = history[undoPointer];
            }
        }

        function downloadImage() {
            // Apply CSS filter to baked-in canvas pixels before export
            const temp = document.createElement('canvas');
            temp.width = canvas.width;
            temp.height = canvas.height;
            const tctx = temp.getContext('2d');
            tctx.filter = currentFilter;
            tctx.drawImage(canvas, 0, 0);
            
            const link = document.createElement('a');
            link.download = `snap-pro-${Date.now()}.png`;
            link.href = temp.toDataURL();
            link.click();
            showToast("Saved to downloads");
        }

        function resetApp() {
            if (confirm("Reset current project?")) location.reload();
        }

        function showToast(msg, type = "info") {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `mb-3 px-4 py-2 bg-slate-800 border-l-4 border-indigo-500 rounded shadow-xl text-sm transition-all duration-300 transform translate-y-4 opacity-0`;
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-y-4', 'opacity-0'); }, 10);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2500);
        }
    </script>
</body>
</html>